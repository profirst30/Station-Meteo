\documentclass[12pt]{article}
%\usepackage[a4paper,width=150mm,top=10mm,bottom=20mm]{geometry}
\usepackage[a4paper,width=160mm,top=25mm,bottom=25mm]{geometry}

\input{dependencies}


\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[french]{babel}
\usepackage{titling}
\usepackage{graphicx}
\usepackage{svg}
% Ajouter dans le préambule du document :
\usepackage{minted}
\usepackage{xcolor}
\usepackage{float}
\floatplacement{figure}{H}
\usepackage[colorlinks=true, linkcolor=blue]{hyperref}
\usepackage[all]{hypcap}
\usepackage{amsmath}
\usepackage{fancyhdr}
\usepackage{lastpage}



%\geometry{margin=2.5cm}
\setlength{\headheight}{15pt}

% Configuration de fancyhdr

\fancyhf{} % Efface tous les champs d'en-tête et de pied de page
\renewcommand{\headrulewidth}{0.4pt} % Ajoute une ligne d'en-tête

% Configuration de l'en-tête pour les pages normales
\fancyhead[L]{\leftmark}
\fancyhead[R]{\rightmark}

% Configuration pour la première page
\fancypagestyle{plain}{
    \fancyhf{} % Efface les en-têtes et pieds de page par défaut
}











    
\begin{document} 

\input{titlepage}



\pagenumbering{gobble}


\tableofcontents
\label{toc} % Étiquette pour le lien


\listoffigures

\newpage


\clearpage
\setcounter{page}{3}
\pagenumbering{arabic}
\fancyfoot[C]{\hyperlink{toc}{\thepage} / \pageref{LastPage}} % Numéro de page au centre avec total
 %\fancyfoot[R]{\hyperlink{toc}{\thepage}}

\pagestyle{fancy}

\nsection{Introduction}

Le réchauffement climatique est un des défis majeurs auquel l’humanité aura à faire face dans les prochaines années. L’influence de l’activité humaine, longtemps contestée, ne fait plus aucun doute. D’après un récent rapport de l’Organisation Météorologique Mondiale, 2019 est la 5\textsuperscript{ème} année la plus chaude depuis le début des relevés météorologiques en 1850. La température moyenne en 2018 est de 1°C supérieure à celle relevée à l’ère préindustrielle.

Selon les travaux des scientifiques du GIEC, si l’humanité veut continuer à vivre sur la planète sans subir des changements climatiques catastrophiques mettant en cause sa survie et celle de tous les êtres vivants, cette température moyenne ne devra pas excéder 1.5°C d’ici à la fin de ce siècle.

Dans ce contexte, il est intéressant de pouvoir disposer d’un équipement permettant de relever les différentes grandeurs météorologiques du lieu où l’on se trouve.

L’objectif de ce projet, utilisant un système embarqué, est donc de concevoir et de réaliser une station météorologique.

\newpage
\vspace{0.5cm}



\section{Cahier des charges}

L'objectif de ce projet est de réaliser une station météorologique utilisant une carte STM32F746G DIscovery.
Cette station doit etre capable de mesurer : 
\begin{itemize}
    \item La température
    \item La pression atmosphérique
    \item L'humidité
    \item La luminosité
    \item La direction et la vitesse du vent
    \item La quantité d'eau tombée en une journée (pluviométrie)
\end{itemize}
Ces mesures seront affichées et stockées directement sur la station (en utilisant le LCD et le lecteur de carte SD de la carte Discovery) et pourront également être transmises par radio vers un dispositif distant (smartphone, Raspberry Pi, etc.).


\subsection{Table des Entrées/Sorties}

\begin{table}[H]
\centering
\caption{Table des Entrées/Sorties du système}
\begin{tabular}{|l|l|l|l|l|}
\hline
\textbf{Composant} & \textbf{Type} & \textbf{Interface} & \textbf{Pins STM32} & \textbf{Caractéristiques} \\
\hline
HTS221 & Entrée & I2C1 & 
\begin{tabular}[c]{@{}l@{}}
PB8 (SCL)\\
PB9 (SDA)
\end{tabular} & 
\begin{tabular}[c]{@{}l@{}}
Humidité: 0-100\%\\
Temp: -40 à +120°C
\end{tabular} \\
\hline
LPS22HH & Entrée & I2C1 & 
\begin{tabular}[c]{@{}l@{}}
PB8 (SCL)\\
PB9 (SDA)
\end{tabular} & 
Pression: 260-1260 hPa \\
\hline
Anémomètre & Entrée & GPIO & PC6 & 2,4km/h = 1Hz \\
\hline
Girouette & Entrée & ADC & PA0 & 16 positions (0-360°) \\
\hline
Pluviomètre & Entrée & GPIO & PC8 & 0,2794mm/impulsion \\
\hline
Écran LCD & Sortie & LTDC & 
\begin{tabular}[c]{@{}l@{}}
Multiple pins\\
(voir datasheet)
\end{tabular} & 480x272 pixels \\
\hline
Carte SD & E/S & SDIO & 
\begin{tabular}[c]{@{}l@{}}
PC8-PC11\\
(données)\\
PC12 (CLK)\\
PD2 (CMD)
\end{tabular} & Mode 4-bits \\
\hline
\end{tabular}
\end{table}


\section{Caractéristiques du shield ST X-NUCLEO-IKS01A3}

\subsection{Capteurs}
\begin{itemize}
    \item \textbf{LSM6DSO}: Accéléromètre 3D ($\pm2/\pm4/\pm8/\pm16g$) et gyroscope 3D ($\pm125/\pm250/\pm500/\pm1000/\pm2000$ dps)
    \item \textbf{LIS2MDL}: Magnétomètre 3D ($\pm50$ gauss)
    \item \textbf{LIS2DW12}: Accéléromètre 3D ($\pm2/\pm4/\pm8/\pm16g$)
    \item \textbf{LPS22HH}: Capteur de pression (baromètre à sortie numérique absolue de 260-1260 hPa)
    \item \textbf{HTS221}: Capteur d'humidité relative et de température
    \item \textbf{STTS751}: Capteur de température (plage de $-40°C$ à $+125°C$)
\end{itemize}

\subsection{Connectivité et compatibilité}
\begin{itemize}
    \item Compatible avec la disposition du connecteur Arduino UNO R3
    \item S'interface avec les microcontrôleurs STM32 via la broche I2C (possibilité de modifier le port I2C par défaut)
    \item Compatible avec les cartes Nucleo STM32
\end{itemize}

\subsection{Caractéristiques supplémentaires}
\begin{itemize}
    \item Embase DIL 24 broches disponible pour adaptateurs MEMS supplémentaires et autres capteurs
    \item Fonctionnalités de hub pour capteurs I2C avec LSM6DSO
    \item Bibliothèque de firmware de développement complète et gratuite, avec exemples pour tous les capteurs, compatible avec le micrologiciel STM32Cube
\end{itemize}

\subsection{Configuration matérielle}
La carte peut être configurée en deux modes :
\begin{enumerate}
    \item \textbf{Mode standard}: Tous les dispositifs sur le même bus I2C
    \item \textbf{Mode SensorHub}: LSM6DSO et LIS2DW12 sur I2C2, autres dispositifs connectés au maître LSM6DSO via I2C1
\end{enumerate}

\subsection{Alimentation}
\begin{itemize}
    \item Chaque dispositif dispose d'une alimentation séparée pour la mesure individuelle de la consommation d'énergie
    \item Un LDO génère 1,8V pour la plupart des capteurs MEMS
    \item Un LDO séparé génère 2,5V pour le STTS751
\end{itemize}

\section{Choix des capteurs}
\subsection{Température,humidité et pression atmosphérique}

La récupération des données des capteurs sur la carte d'extension \textbf{X-NUCLEO-IKS01A3} se fait principalement via le bus \textbf{I2C} (Inter-Integrated Circuit).

\subsection*{Configurations possibles}

La carte peut être configurée de deux manières différentes pour la communication I2C :
\begin{itemize}
    \item \textbf{Mode standard} : Tous les capteurs sont connectés sur un seul bus I2C.
    \item \textbf{Mode SensorHub} :
    \begin{itemize}
        \item \textbf{LSM6DSO} et \textbf{LIS2DW12} sont connectés au bus \textbf{I2C2}.
        \item Les autres capteurs (\textbf{LIS2MDL}, \textbf{LPS22HH}, \textbf{HTS221}, \textbf{STTS751}) sont connectés au \textbf{LSM6DSO} via le bus \textbf{I2C1}.
    \end{itemize}
\end{itemize}

Le choix du mode se fait par la configuration des cavaliers \textbf{JP7} et \textbf{JP8} sur la carte.

\subsection*{Particularités}

\begin{itemize}
    \item La carte s'interface avec les microcontrôleurs \textbf{STM32} via la broche \textbf{I2C1}.
    \item Il est possible de modifier le port I2C par défaut si nécessaire.
    \item Le \textbf{LSM6DSO} peut fonctionner comme un hub I2C pour les autres capteurs.
\end{itemize}

Cette flexibilité dans la configuration du bus I2C permet d'adapter la carte à différents besoins et scénarios d'utilisation.

\subsection{Capteurs de vitesse et direction du vent}
Le capteur de vitesse du vent, ou \textbf{anémomètre}, est de type à coupelles. Il mesure la vitesse du vent en fermant un contact lorsqu'un aimant passe devant un interrupteur. 
\begin{itemize}
    \item Une vitesse de vent de \textbf{2,4 km/h} provoque la fermeture de l'interrupteur une fois par seconde.
    \item L'interrupteur de l'anémomètre est connecté aux deux conducteurs intérieurs du câble \textbf{RJ11} partagé par l'anémomètre et la girouette (broches 2 et 3).
\end{itemize}

Le capteur de direction du vent, ou \textbf{girouette}, est le plus complexe des trois capteurs. 
\begin{itemize}
    \item Il possède huit interrupteurs, chacun connecté à une résistance différente.
    \item L'aimant de la girouette peut fermer deux interrupteurs à la fois, ce qui permet d'indiquer jusqu'à \textbf{16 positions différentes}.
    \item Une résistance externe peut être utilisée pour former un diviseur de tension, produisant une tension de sortie mesurable avec un convertisseur analogique-numérique.
\end{itemize}

Les valeurs de résistance pour toutes les 16 positions possibles sont données dans le tableau du document source. Les valeurs de résistance pour les positions intermédiaires sont le résultat de deux résistances adjacentes connectées en parallèle lorsque l'aimant de la girouette active deux interrupteurs simultanément.

\subsection{Capteur de pluie}
Le capteur de pluie utilise le principe du \textbf{« tipping bucket »}, aussi appelé \textbf{auget basculeur}. Ce type de pluviomètre est constitué de deux petits récipients montés sur un axe horizontal. Lorsqu'un récipient est rempli par l'eau de pluie, il bascule sous son poids, vidant son contenu et permettant à l'autre récipient de se remplir. Chaque basculement ferme un contact électrique qui peut être enregistré par un compteur numérique ou une interruption de microcontrôleur.

\subsection*{Récupération des données de pluviométrie avec le STM32}

Pour récupérer l'information de pluviométrie avec le \textbf{STM32}, il faut :
\begin{itemize}
    \item Connecter l'interrupteur du pluviomètre aux deux conducteurs centraux d'un câble \textbf{RJ11}.
    \item Configurer une broche du \textbf{STM32} en entrée d'interruption pour détecter la fermeture du contact.
    \item Compter le nombre d'interruptions pour déterminer la quantité de pluie tombée.
\end{itemize}

Chaque basculement correspond à une quantité de pluie précise. Dans ce cas, chaque basculement de l'auget représente \textbf{0,2794 mm} de pluie.
\newpage

\section{Développement et validation unitaire}

\subsection{Stratégie de test}
Avant l'intégration complète du système, chaque composant a été testé individuellement pour garantir son bon fonctionnement. Cette approche nous a permis de :
\begin{itemize}
    \item Valider le fonctionnement de chaque capteur individuellement
    \item Identifier et corriger les problèmes au plus tôt
    \item Établir une base solide pour l'intégration finale
\end{itemize}

\subsection{Capteurs environnementaux (HTS221 et LPS22HH)}
\subsubsection{Configuration}
La communication avec ces capteurs est réalisée via le bus I2C1. Voici les étapes de validation :
\begin{enumerate}
    \item Test de présence des capteurs sur le bus I2C
    \item Configuration des registres de contrôle
    \item Validation de la récupération des données
\end{enumerate}

\subsubsection{Tests réalisés}
\begin{itemize}
    \item Lecture des identifiants des capteurs
    \item Vérification de la cohérence des mesures
    \item Test de la fréquence d'échantillonnage
\end{itemize}

[Insérer capture d'écran du terminal montrant les mesures]

\subsection{Anémomètre et Girouette}
\subsubsection{Configuration matérielle}
L'anémomètre nécessite :
\begin{itemize}
    \item Une entrée GPIO configurée en interruption externe
    \item Une résistance de pull-up pour stabiliser le signal
\end{itemize}

\subsubsection{Validation}
Tests effectués à l'aide d'un oscilloscope et du logiciel Analog Discovery :
\begin{itemize}
    \item Mesure de la fréquence des impulsions
    \item Validation de la conversion fréquence/vitesse
    \item Test des 16 positions de la girouette
\end{itemize}

[Insérer capture d'écran de l'oscilloscope]

\subsection{Pluviomètre}
\subsubsection{Configuration matérielle}
Le pluviomètre de type "tipping bucket" nécessite :
\begin{itemize}
    \item Une entrée GPIO configurée en interruption externe
    \item Une résistance de pull-up interne activée
    \item Configuration de l'antirebond logiciel
\end{itemize}

\subsubsection{Tests de validation}
\begin{itemize}
    \item Test unitaire avec simulation manuelle des basculements
    \item Vérification du comptage des impulsions
    \item Validation de la conversion (0,2794 mm par basculement)
    \item Test de l'antirebond
\end{itemize}

\subsection{Interface utilisateur LCD}
\subsubsection{Configuration}
\begin{itemize}
    \item Initialisation du contrôleur LTDC
    \item Configuration de la résolution (480x272)
    \item Configuration du format de couleur (RGB565)
\end{itemize}

\subsubsection{Tests effectués}
\begin{itemize}
    \item Test d'affichage des caractères
    \item Validation du rafraîchissement de l'écran
    \item Test des différentes zones d'affichage
    \item Vérification du contraste et de la lisibilité
\end{itemize}

[Insérer capture d'écran de l'interface]

\subsection{Stockage sur carte SD}
\subsubsection{Configuration}
\begin{itemize}
    \item Initialisation du contrôleur SDMMC en mode 4 bits
    \item Configuration du système de fichiers FAT via FatFS
    \item Configuration du DMA pour les transferts
\end{itemize}

\subsubsection{Validation}
\begin{itemize}
    \item Test de création de fichiers
    \item Validation de l'écriture et lecture des données
    \item Test de performance en écriture continue
    \item Vérification de l'intégrité des données
\end{itemize}

[Insérer capture d'écran du contenu d'un fichier de log]

\subsection{Communication radio}
\subsubsection{Configuration matérielle}
\begin{itemize}
    \item Configuration du module radio 
    \item Paramétrage du débit et de la puissance d'émission
    \item Configuration du protocole de communication
\end{itemize}

\subsubsection{Tests de validation}
\begin{itemize}
    \item Test de portée
    \item Validation de la fiabilité de la transmission
    \item Test de la consommation énergétique
    \item Vérification de l'intégrité des données transmises
\end{itemize}

[Insérer capture d'écran des données reçues]

\section{Développement et validation des éléments d'assemblage}

\subsection{Agrégation des mesures}
\subsubsection{Architecture logicielle}
L'agrégation des mesures a été implémentée selon une architecture à trois niveaux :
\begin{itemize}
    \item Niveau acquisition : lecture des capteurs avec gestion des temporisations
    \item Niveau traitement : moyennage et filtrage des données
    \item Niveau stockage : formatage et sauvegarde des données
\end{itemize}

\subsubsection{Stratégie d'échantillonnage}
\begin{itemize}
    \item Capteurs I2C (température, humidité, pression) : échantillonnage périodique (1Hz)
    \item Anémomètre : calcul de la vitesse sur fenêtre glissante de 5 secondes
    \item Pluviomètre : cumul sur période configurable (heure/jour)
    \item Horodatage via RTC pour chaque série de mesures
\end{itemize}

\subsubsection{Tests d'intégration}
\begin{itemize}
    \item Validation de la synchronisation des mesures
    \item Test de charge (acquisition continue sur 24h)
    \item Vérification de la cohérence temporelle des données
    \item Test des mécanismes de reprise sur erreur
\end{itemize}

\subsection{Gestion de l'IHM}
\subsubsection{Organisation de l'interface}
L'interface utilisateur a été conçue pour être intuitive et fonctionnelle :
\begin{itemize}
    \item Écran principal : affichage en temps réel des mesures courantes
    \item Écran statistiques : valeurs min/max/moyennes sur 24h
    \item Écran configuration : paramètres système et calibration
    \item Zone d'état : indication des erreurs et état du système
\end{itemize}

[Insérer capture d'écran de l'interface principale]

\subsubsection{Gestion des événements}
\begin{itemize}
    \item Rafraîchissement périodique des valeurs (1Hz)
    \item Gestion des alertes (dépassement de seuils)
    \item Historique des événements remarquables
    \item Interface de configuration des paramètres
\end{itemize}

\subsubsection{Tests de validation}
\begin{itemize}
    \item Test de réactivité de l'interface
    \item Validation du comportement avec charge CPU importante
    \item Test des différents scénarios d'utilisation
    \item Vérification de la persistance des paramètres
\end{itemize}

\nsection{Conclusion}

Ce projet a été d'une grande richesse en termes d'apprentissage. Il nous a permis de mettre en pratique les connaissances acquises en cours de systèmes embarqués. Nous avons pu découvrir les différentes étapes de la conception d'un système embarqué, de la spécification des besoins à la réalisation du système en passant par la conception et la programmation.
\end{document}